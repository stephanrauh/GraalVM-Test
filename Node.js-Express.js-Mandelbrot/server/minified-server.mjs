import cluster from"cluster";import{cpus}from"os";import{existsSync,readFileSync}from"fs";import{createServer}from"http";import process from"process";let numCPUs=cpus;if(numCPUs=4,cluster.isPrimary){console.log(`starting ${numCPUs} processes`);for(var i=0;i<numCPUs;i++)cluster.fork()}else startServer();function startServer(){createServer(dispatcher).listen(4200),console.log("listening on port 4200...")}function dispatcher(e,t){let n=e.url;"/"==n&&(n="/index.html"),console.log("request for "+n),n.startsWith("/db.json")?serveMandelbrotSet(e,t,n):n.startsWith("/version")?serveVersionNumbers(t):serveIndexHtml(n,t)}function serveIndexHtml(e,t){let n="";return existsSync("client"+e)&&(e=readFileSync("client"+e,"utf-8").toString(),t.writeHead(200,{"Content-Type":"text/html"}),n=e),t.write(n),t.end(),n}function serveVersionNumbers(e){let t="";var n=process.version,r=process.argv0.split("/").find(e=>e.startsWith("graalvm"));return t=r?r+" (Node.js "+n+")":"Node.js "+n,e.writeHead(200,{"Content-Type":"text/plain"}),e.write(t),e.end(),t}function decodeGetParams(e){var t={};if(e=e.split("?")[1]){var n=e.split("&");for(let e=0;e<n.length;e++){var r=n[e].split("=");t[r[0]]=r[1]}}return t}function parseurl(e){console.log(e);var e=decodeGetParams(e),t=parseFloat(e.zoom),n=parseFloat(e.x)-1/t,r=parseFloat(e.x)+1/t,i=parseFloat(e.y)-1/t,o=parseFloat(e.y)+1/t,s=(console.log(`Coordinates: (${n},${i}) - (${r},${o})`),parseInt(e.size));return{mb_answer:{maxx:r,maxi:o,minx:n,mini:i,width:Math.abs(r-n),height:Math.abs(o-i),zoom:t,length:0,requestcount:0,points:[]},size:s,id:parseInt(e.id)}}function serveMandelbrotSet(r,i,e){console.log("client requesting stream"),i.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),i.write("\n\n");let o=(new Date).getTime(),s=parseurl(e),l=s.mb_answer,a=s.id,c={allPointsC:[],allPointsZ:[],allPointsPx:[]};if(-1!=initializeMB(c,l,s.size)){let t=null,n=0;return t=setInterval(function(){var e;null!=r.socket._handle?r.socket._handle.writeQueueSize<=5?(iterateEverythingOnce(c,l,s.size),0<l.points.length?(l.requestcount=n,o=(new Date).getTime(),e=JSON.stringify(l),i.write("id:"+a+"\n"),i.write("data:"+e+"\n\n"),l.points=[],n++):5e3<(new Date).getTime()-o&&(clearInterval(t),console.log("no more points found for stream id: "+a),c={},l={},i.end())):(clearInterval(t),console.log("closed because writeQueueSize is too lage; stream id: "+a),c={},l={},i.end()):(clearInterval(t),console.log("closed because _handle is null; stream id: "+a),c={},l={},i.end())},1),r.connection.addListener("close",function(){clearInterval(t),console.log("client closed stream id: "+a),c={},l={},i.end()},!1),0}console.log("the zoom factor is too large"),i.write("id:"+a+"\n"),i.write("data: zoomfactorinvalid\n\n"),i.end()}function initializeMB(e,t,n){var r=Math.abs(t.maxx-t.minx),i=Math.abs(t.maxi-t.mini)/n,o=r/n;if(1-o==1)return-1;e.allPointsC=new Array(n*n),e.allPointsZ=new Array(n*n),e.allPointsPx=new Array(n*n);let s=0,l=t.maxi,a=0;for(;l>=t.mini;){for(a=t.maxx;a>=t.minx;).14<(a+.35)*(a+.35)+l*l&&.04<(a+1)*(a+1)+l*l&&(e.allPointsC[s]=[a,l],e.allPointsZ[s]=[a,l]),s+=1,a-=o;l-=i}return 1}function iterateEverythingOnce(t,n,r){let i=0;for(let e=0;e<t.allPointsC.length;e++){var o=t.allPointsC[e];void 0!==o&&(i=iterateOnePixelOnce(t,e,o,i,n,r))}n.points=t.allPointsPx.slice(0,i),n.length=i}function iterateOnePixelOnce(e,t,n,r,i,o){var s=e.allPointsZ[t],l=s[0],a=s[1];return l*l+a*a<4?{zi:a,zx:l}=doIterateOnePixel(a,l,n,s):r=markPixelAsDiverging(e,r,n,i,o,t),r}function markPixelAsDiverging(e,t,n,r,i,o){return e.allPointsPx[t]=[((n[0]-r.minx)*i/r.width).toFixed(0),((n[1]-r.mini)*i/r.height).toFixed(0)],t++,e.allPointsC[o]=void 0,t}function doIterateOnePixel(e,t,n,r){var i=e;return e=2*t*e+n[1],t=t*t-i*i+n[0],r[0]=t,{zi:r[1]=e,zx:t}}